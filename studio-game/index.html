&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
    &lt;title&gt;Reakt Studio Game - Lobby &amp; Studio&lt;/title&gt;
    &lt;script src=&quot;https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;https://cdn.skypack.dev/three@0.167.1&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;https://cdn.skypack.dev/tone@14.8.49&quot;&gt;&lt;/script&gt;
    &lt;style&gt;
        body { margin: 0; overflow: hidden; font-family: Arial; }
        #ui { position: absolute; top: 10px; left: 10px; z-index: 100; }
        #chat { width: 300px; height: 300px; background: rgba(0,0,0,0.7); color: white; overflow-y: auto; padding: 10px; font-size: 12px; }
        #input { position: absolute; bottom: 10px; left: 10px; width: 280px; }
        #msg { width: 220px; }
        button { padding: 5px 10px; margin: 2px; }
        #studio { position: absolute; bottom: 60px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 10px; display: none; }
        #status { position: absolute; top: 10px; right: 10px; background: rgba(0,255,0,0.5); color: black; padding: 10px; }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div id=&quot;ui&quot;&gt;
        &lt;div id=&quot;status&quot;&gt;Loading...&lt;/div&gt;
        &lt;div id=&quot;chat&quot;&gt;&lt;/div&gt;
        &lt;input id=&quot;msg&quot; type=&quot;text&quot; placeholder=&quot;Chat message...&quot;&gt;
        &lt;button onclick=&quot;sendMsg()&quot;&gt;Send&lt;/button&gt;
        &lt;br&gt;
        &lt;button onclick=&quot;toggleStudio()&quot;&gt;&lt;span id=&quot;studioBtnText&quot;&gt;Enter Studio&lt;/span&gt;&lt;/button&gt;
    &lt;/div&gt;
    &lt;div id=&quot;studio&quot;&gt;
        &lt;button onclick=&quot;generatePattern()&quot;&gt;Gen Beats&lt;/button&gt;
        &lt;button onclick=&quot;Tone.Transport.toggle()&quot;&gt;Play/Stop&lt;/button&gt;
        &lt;p&gt;Procedural synth &amp; beats&lt;/p&gt;
    &lt;/div&gt;
    &lt;script&gt;
        // Firebase config
        const firebaseConfig = {
            apiKey: &quot;AIzaSyDAEbCwIrpBmC-hSDEHcKquU-jXX6C1Q4E&quot;,
            authDomain: &quot;reakt-v2-f5e46.firebaseapp.com&quot;,
            databaseURL: &quot;https://reakt-v2-f5e46-default-rtdb.europe-west1.firebasedatabase.app&quot;,
            projectId: &quot;reakt-v2-f5e46&quot;,
            storageBucket: &quot;reakt-v2-f5e46.firebasestorage.app&quot;,
            messagingSenderId: &quot;109598378592&quot;,
            appId: &quot;1:109598378592:web:9bf5f3539478a20f5c9105&quot;
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let uid, color, userRef, playerAvatar, synth, kick, loopId, pattern = new Array(16).fill(0);
        let scene, camera, renderer, avatars = {}, plane, clock = new THREE.Clock();
        let mouseX = 0, mouseZ = 0, inStudio = false;

        // Init Three.js
        function initThree() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x111133);
            scene.fog = new THREE.Fog(0x111133, 10, 100);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 15, 20);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.body.appendChild(renderer.domElement);

            // Lights
            const ambient = new THREE.AmbientLight(0x404040, 0.4);
            scene.add(ambient);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(10, 20, 5);
            dirLight.castShadow = true;
            dirLight.shadow.mapSize.width = 2048;
            dirLight.shadow.mapSize.height = 2048;
            scene.add(dirLight);

            // Ground plane
            const planeGeo = new THREE.PlaneGeometry(200, 200);
            const planeMat = new THREE.MeshStandardMaterial({ color: 0x444444, roughness: 0.8 });
            plane = new THREE.Mesh(planeGeo, planeMat);
            plane.rotation.x = -Math.PI / 2;
            plane.receiveShadow = true;
            scene.add(plane);

            // Mouse control
            document.addEventListener('mousemove', (e) =&gt; {
                mouseX = (e.clientX / window.innerWidth - 0.5) * 30;
                mouseZ = -(e.clientY / window.innerHeight - 0.5) * 30;
            });

            window.addEventListener('resize', () =&gt; {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            animate();
        }

        function createAvatar(color) {
            const group = new THREE.Group();
            const bodyMat = new THREE.MeshStandardMaterial({ color });
            // Body
            const body = new THREE.Mesh(new THREE.CylinderGeometry(0.25, 0.35, 1.0, 8), bodyMat);
            body.position.y = 0.6;
            body.castShadow = true;
            group.add(body);
            // Head
            const head = new THREE.Mesh(new THREE.SphereGeometry(0.25, 8, 8), bodyMat);
            head.position.y = 1.45;
            head.castShadow = true;
            group.add(head);
            return group;
        }

        function updateAvatars(snapshot) {
            const data = snapshot.val() || {};
            Object.entries(data).forEach(([id, d]) =&gt; {
                if (id !== uid) {
                    if (!avatars[id]) {
                        avatars[id] = createAvatar(d.color || '#ffffff');
                        scene.add(avatars[id]);
                    }
                    avatars[id].position.set(d.x || 0, 0.5, d.z || 0);
                } else if (inStudio &amp;&amp; playerAvatar) {
                    playerAvatar.position.set(d.x || 0, 0.5, d.z || 0);
                }
            });
            // Remove missing
            Object.keys(avatars).forEach(id =&gt; {
                if (!data[id]) {
                    scene.remove(avatars[id]);
                    delete avatars[id];
                }
            });
        }

        function updatePlayerPos() {
            if (uid &amp;&amp; userRef) {
                userRef.update({ x: mouseX, z: mouseZ });
            }
            if (inStudio &amp;&amp; playerAvatar) {
                playerAvatar.position.x = THREE.MathUtils.lerp(playerAvatar.position.x, mouseX, 0.1);
                playerAvatar.position.z = THREE.MathUtils.lerp(playerAvatar.position.z, mouseZ, 0.1);
                playerAvatar.position.y = 0.5 + Math.sin(clock.getElapsedTime() * 4) * 0.2;
            }
        }

        // Chat
        const chatDiv = document.getElementById('chat');
        function sendMsg() {
            const text = document.getElementById('msg').value.trim();
            if (text &amp;&amp; uid) {
                db.ref('messages').push({ uid: uid.slice(0,6), text, time: Date.now() });
                document.getElementById('msg').value = '';
            }
        }
        document.getElementById('msg').addEventListener('keypress', (e) =&gt; {
            if (e.key === 'Enter') sendMsg();
        });
        db.ref('messages').limitToLast(50).on('child_added', (snap) =&gt; {
            const m = snap.val();
            const div = document.createElement('div');
            div.textContent = `[${new Date(m.time).toLocaleTimeString()}] ${m.uid}: ${m.text}`;
            chatDiv.appendChild(div);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        });

        // Studio
        function toggleStudio() {
            inStudio = !inStudio;
            document.getElementById('studio').style.display = inStudio ? 'block' : 'none';
            document.getElementById('studioBtnText').textContent = inStudio ? 'Exit Studio' : 'Enter Studio';
            camera.position.y = inStudio ? 8 : 15;
            camera.position.z = inStudio ? 12 : 20;
            if (inStudio) {
                if (!playerAvatar) {
                    playerAvatar = createAvatar(color);
                    scene.add(playerAvatar);
                }
                // Init music
                synth = new Tone.Synth().toDestination();
                kick = new Tone.MembraneSynth({pitchDecay: 0.05}).toDestination();
                Tone.Transport.bpm.value = 130;
                generatePattern();
            } else {
                if (Tone.Transport.state === 'started') Tone.Transport.stop();
            }
            camera.lookAt(mouseX, 0, mouseZ);
        }

        function generatePattern() {
            for (let i = 0; i &lt; 16; i++) {
                pattern[i] = Math.random() &lt; 0.25 ? 1 : 0;
            }
        }

        function initMusicLoop() {
            const loop = new Tone.Loop((time) =&gt; {
                const step = Math.floor(Tone.Transport.ticks / 6) % 16;  // 16th notes (480 ticks/beat / 30? approx 16th
                if (pattern[step]) {
                    kick.triggerAttackRelease('C1', '16n', time);
                }
                if (Math.random() &lt; 0.15) {
                    synth.triggerAttackRelease(Tone.Frequency(Math.random() * 400 + 200).toNote(), '8n', time);
                }
            }, '16n');
            loop.start(0);
            Tone.Transport.start();
        }

        // Auth
        auth.signInAnonymously().catch(console.error);
        auth.onAuthStateChanged((user) =&gt; {
            if (user) {
                uid = user.uid;
                color = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
                userRef = db.ref('users/' + uid);
                userRef.set({ x: 0, y: 0, z: 0, color });
                userRef.onDisconnect().remove();
                db.ref('users').on('value', updateAvatars);
                document.getElementById('status').textContent = `Logged in as ${uid.slice(0,8)} | Vlad test ready`;
                // Start pos update
                setInterval(updatePlayerPos, 50);
            } else {
                document.getElementById('status').textContent = 'Auth failed';
            }
        });

        function animate() {
            requestAnimationFrame(animate);
            camera.lookAt(mouseX, 0, mouseZ);
            camera.position.x = THREE.MathUtils.lerp(camera.position.x, mouseX, 0.05);
            if (inStudio &amp;&amp; Tone.Transport.state === 'started' &amp;&amp; !loopId) {
                initMusicLoop();
            }
            renderer.render(scene, camera);
        }

        initThree();
    &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;